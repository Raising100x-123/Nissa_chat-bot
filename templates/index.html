<!DOCTYPE html>
<html lang="en" data-language="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mTouchLabs - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .upload-section {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-button:hover {
            background: #5a6fd8;
        }

        .upload-button {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .upload-button:hover {
            background: #218838;
        }

        .upload-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .upload-button.loading {
            position: relative;
            color: transparent;
        }

        .upload-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .selected-files {
            font-size: 12px;
            color: #666;
            flex: 1;
            min-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            display: block;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .message-image.loading {
            opacity: 0.5;
        }

        .message-image.error {
            opacity: 0.7;
            border: 2px solid #dc3545;
        }

        .message-content a {
            display: block;
            text-decoration: none;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #667eea;
        }

        .message.assistant .message-avatar {
            background: #28a745;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-image {
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            display: block;
            transition: opacity 0.3s;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.3s;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            margin-bottom: 20px;
        }

        .typing-indicator .message-content {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .status-indicator {
            padding: 10px 20px;
            border-radius: 5px;
            margin: 10px 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .status-indicator.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-indicator.info {
            background: #cce5ff;
            border: 1px solid #b8daff;
            color: #004085;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
                padding: 0;
            }
            .chat-header {
                border-radius: 0;
            }
            .message-content {
                max-width: 85%;
            }
            .message-image {
                width: 100%;
            }
            .chat-header h1 {
                font-size: 20px;
            }
            .file-upload {
                flex-direction: column;
                align-items: stretch;
            }
            .file-input-wrapper,
            .upload-button {
                width: 100%;
                margin-bottom: 10px;
            }
            .selected-files {
                width: 100%;
                text-align: center;
                margin-top: 5px;
            }
            .chat-input-container {
                padding: 15px;
            }
            .chat-input {
                padding: 12px 15px;
                font-size: 15px;
            }
            .send-button {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container" role="main" aria-label="mTouchLabs AI Assistant Chat Interface">
        <div class="chat-header">
            <h1>mTouchLabs AI Assistant</h1>
            <p>Powered by Gemini AI - Nisaa</p>
        </div>

        <div class="upload-section">
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.txt" aria-label="Choose PDF or TXT files" aria-controls="uploadButton selectedFiles">
                    <div class="file-input-button" role="button" aria-label="Choose files">Choose Files (PDF/TXT)</div>
                </div>
                <button id="uploadButton" class="upload-button" disabled aria-label="Upload selected files">Upload & Initialize</button>
                <div id="selectedFiles" class="selected-files" role="status" aria-live="polite">No files selected</div>
            </div>
        </div>

        <div id="statusIndicator" class="status-indicator"></div>

        <div class="chat-messages" id="chatMessages" role="log" aria-live="polite">
            <div class="welcome-message" role="region" aria-label="Welcome Message">
                <h2>Welcome to mTouchLabs!</h2>
                <p>I'm <em>Nisaa</em>, your AI assistant. I'm here to help with technology solutions and digital transformation.</p>
                <p>Please upload documents for contextual assistance, or ask general questions like "show 360 view".</p>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" class="chat-input" placeholder="Initializing assistant..." disabled aria-label="Type your message" aria-controls="sendButton">
                <button id="sendButton" class="send-button" disabled aria-label="Send message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const fileInput = document.getElementById('fileInput');
const uploadButton = document.getElementById('uploadButton');
const selectedFilesDiv = document.getElementById('selectedFiles');
const statusIndicator = document.getElementById('statusIndicator');
const chatMessagesContainer = document.getElementById('chatMessages');

let sessionId = null;
let isChatReady = false;
let typingIndicatorMessageElement = null;

async function initializeAssistant() {
    chatInput.placeholder = "Connecting to assistant...";
    try {
        const sessionResponse = await fetch('/generate_session', { method: 'GET' });
        if (!sessionResponse.ok) throw new Error(`Session failed: ${sessionResponse.status}`);
        const sessionData = await sessionResponse.json();
        sessionId = sessionData.session_id;
        console.log("Session ID:", sessionId);

        const healthResponse = await fetch('/health', { method: 'GET' });
        if (!healthResponse.ok) throw new Error(`Health check failed: ${healthResponse.status}`);
        const healthData = await healthResponse.json();
        console.log("Health check:", healthData);

        if (healthData.status === 'healthy') {
            isChatReady = true;
            enableChat();
            const docCount = healthData.documents_indexed || 0;
            showStatus(`Assistant ready! ${docCount} document chunks indexed.`, 'success');
        } else {
            isChatReady = false;
            disableChat();
            showStatus('Assistant unavailable. Please upload documents or refresh.', 'error');
        }
    } catch (error) {
        console.error('Init error:', error);
        disableChat();
        showStatus(`Init failed: ${error.message}. Refresh page.`, 'error');
    }
}

function enableChat() {
    chatInput.disabled = false;
    sendButton.disabled = false;
    chatInput.placeholder = "Ask about mTouchLabs services...";
    chatInput.focus();
}

function disableChat() {
    chatInput.disabled = true;
    sendButton.disabled = true;
    chatInput.placeholder = "Assistant not ready or processing...";
}

function showStatus(message, type = 'success') {
    statusIndicator.textContent = message;
    statusIndicator.className = `status-indicator ${type}`;
    statusIndicator.style.display = 'block';
    setTimeout(() => {
        if (statusIndicator.textContent === message) statusIndicator.style.display = 'none';
    }, 7000);
}

fileInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files).filter(file =>
        file.name.toLowerCase().endsWith('.pdf') || file.name.toLowerCase().endsWith('.txt')
    );
    selectedFilesDiv.textContent = files.length ? `${files.length} file(s): ${files.map(f => f.name).join(', ').substring(0, 50)}...` : 'No valid PDF or TXT files';
    uploadButton.disabled = !files.length;
});

uploadButton.addEventListener('click', async function() {
    if (!fileInput.files.length) {
        showStatus('Please select files to upload', 'error');
        return;
    }

    const formData = new FormData();
    for (let file of fileInput.files) formData.append('files', file);

    this.disabled = true;
    this.classList.add('loading');
    fileInput.disabled = true;
    disableChat();
    showStatus('Uploading and processing documents...', 'info');

    try {
        const response = await fetch('/upload_documents', { method: 'POST', body: formData });
        const result = await response.json();

        if (response.ok) {
            showStatus(result.message || 'Documents processed!', 'success');
            isChatReady = true;
            enableChat();
            const healthResponse = await fetch('/health');
            const healthData = await healthResponse.json();
            const docCount = healthData.documents_indexed || 0;
            showStatus(`Processed! ${docCount} chunks indexed.`, 'success');
        } else {
            showStatus(result.error || 'Processing failed.', 'error');
            if (!isChatReady) await initializeAssistant();
        }
    } catch (error) {
        console.error('Upload error:', error);
        showStatus(`Upload error: ${error.message}.`, 'error');
        if (!isChatReady) await initializeAssistant();
    } finally {
        this.classList.remove('loading');
        this.disabled = false;
        fileInput.disabled = false;
        fileInput.value = '';
        selectedFilesDiv.textContent = 'No files selected';
        uploadButton.disabled = true;
    }
});

function getDriveFileId(url) {
    const match = url.match(/\/d\/([^\/]+)\//);
    if (match) return match[1];
    return null;
}

function createMessageElement(isUser = false, content = null, imageData = null, viewData = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.textContent = isUser ? 'You' : 'Nisaa';
    avatarDiv.setAttribute('aria-hidden', 'true');

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.setAttribute('role', 'log');

    // Handle imageData (image preview)
    if (imageData && (imageData.text || imageData.image)) {
        // Add text if provided
        if (imageData.text) {
            const textParagraph = document.createElement('p');
            textParagraph.textContent = imageData.text;
            contentDiv.appendChild(textParagraph);
        }

        // Add image if provided
        if (imageData.image && imageData.link) {
            const link = document.createElement('a');
            link.href = imageData.link;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';

            const img = document.createElement('img');
            img.src = imageData.image;
            img.alt = imageData.alt || 'Preview';
            img.className = 'message-image loading';
            img.setAttribute('role', 'img');

            img.onload = () => img.classList.remove('loading');
            img.onerror = () => {
                img.classList.remove('loading');
                img.classList.add('error');
                img.alt = 'Image failed to load';
            };

            link.appendChild(img);
            contentDiv.appendChild(link);
        }

    } 
    // Handle viewData (array of views/buttons)
    else if (viewData && viewData.text && Array.isArray(viewData.views)) {
        const textParagraph = document.createElement('p');
        textParagraph.textContent = viewData.text;
        contentDiv.appendChild(textParagraph);

        viewData.views.forEach(view => {
            if (view.url && view.label) {
                const link = document.createElement('a');
                link.href = view.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = view.label;
                link.style.display = 'inline-block';
                link.style.marginTop = '8px';
                link.style.padding = '6px 12px';
                link.style.background = '#667eea';
                link.style.color = 'white';
                link.style.borderRadius = '6px';
                link.style.textDecoration = 'none';
                link.style.fontSize = '14px';
                link.style.marginRight = '8px';
                link.style.transition = 'background 0.3s';
                link.addEventListener('mouseover', () => link.style.background = '#5a6fd8');
                link.addEventListener('mouseout', () => link.style.background = '#667eea');

                contentDiv.appendChild(link);
            }
        });
    } 
    // Handle plain text content
    else if (content) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const paragraphs = content.split('\n').filter(p => p.trim());

        paragraphs.forEach(paraText => {
            const p = document.createElement('p');

            if (urlRegex.test(paraText)) {
                const parts = paraText.split(urlRegex);
                parts.forEach(part => {
                    if (urlRegex.test(part)) {
                        const fileId = getDriveFileId(part);
                        if (fileId) {
                            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}`;
                            const link = document.createElement('a');
                            link.href = part;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';

                            const img = document.createElement('img');
                            img.src = thumbnailUrl;
                            img.alt = '360° View Preview';
                            img.className = 'message-image loading';
                            img.setAttribute('role', 'img');

                            img.onload = () => img.classList.remove('loading');
                            img.onerror = () => {
                                img.classList.remove('loading');
                                img.classList.add('error');
                                img.alt = 'Thumbnail failed to load';
                            };

                            link.appendChild(img);
                            p.appendChild(link);
                        } else {
                            const link = document.createElement('a');
                            link.href = part;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.textContent = part;
                            link.style.color = '#667eea';
                            link.style.textDecoration = 'underline';
                            p.appendChild(link);
                        }
                    } else {
                        p.appendChild(document.createTextNode(part));
                    }
                });
            } else {
                p.textContent = paraText;
            }

            contentDiv.appendChild(p);
        });

        if (!contentDiv.childNodes.length) {
            const p = document.createElement('p');
            p.textContent = content || '...';
            contentDiv.appendChild(p);
        }
    } 
    // Fallback if no data
    else {
        const p = document.createElement('p');
        p.textContent = '...';
        contentDiv.appendChild(p);
    }

    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    return messageDiv;
}

function addMessageToChat(element) {
    const welcomeMessage = chatMessagesContainer.querySelector('.welcome-message');
    if (welcomeMessage) welcomeMessage.remove();

    chatMessagesContainer.appendChild(element);

    // Always scroll after adding the message
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

    // Also scroll again if an image in the last message loads later
    setTimeout(() => {
        const lastImage = chatMessagesContainer.querySelector('.message:last-child img');
        if (lastImage) {
            lastImage.onload = () => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            };
        }
    }, 100);
}


function showTypingIndicator() {
    if (typingIndicatorMessageElement) return;

    typingIndicatorMessageElement = document.createElement('div');
    typingIndicatorMessageElement.className = 'message assistant typing-indicator';

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.textContent = 'Nisaa';
    avatarDiv.setAttribute('aria-hidden', 'true');

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    ['typing-dot', 'typing-dot', 'typing-dot'].forEach((className, index) => {
        const dot = document.createElement('div');
        dot.className = className;
        dot.style.animationDelay = `${index * -0.16}s`;
        contentDiv.appendChild(dot);
    });

    typingIndicatorMessageElement.appendChild(avatarDiv);
    typingIndicatorMessageElement.appendChild(contentDiv);
    addMessageToChat(typingIndicatorMessageElement);
}

function hideTypingIndicator() {
    if (typingIndicatorMessageElement) {
        typingIndicatorMessageElement.remove();
        typingIndicatorMessageElement = null;
    }
}

async function sendMessage() {
    const messageText = chatInput.value.trim();
    if (!messageText) return;
    if (!isChatReady) {
        showStatus("Assistant not ready. Upload documents or wait.", 'error');
        return;
    }

    addMessageToChat(createMessageElement(true, messageText));
    chatInput.value = '';
    showTypingIndicator();
    disableChat();

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText, session_id: sessionId })
        });

        hideTypingIndicator();
        const data = await response.json();

        if (response.ok) {
            if (data.type === 'image_link' && data.image) {
                addMessageToChat(createMessageElement(false, null, data));
            } 
            else if (data.type === '360_view') {
                // If an image URL is provided, show it with link
                if (data.image && data.url) {
                    addMessageToChat(
                        createMessageElement(false, null, {
                            text: data.response,
                            image: data.image,
                            link: data.url,
                            alt: (data.label || "360° View") + " preview"
                        })
                    );
                }
                // Else if views array is present
                else if (Array.isArray(data.views)) {
                    addMessageToChat(createMessageElement(false, null, null, data));
                }
                // Fallback to plain text
                else if (typeof data.response === 'string') {
                    addMessageToChat(createMessageElement(false, data.response));
                }
                else {
                    addMessageToChat(createMessageElement(false, "No 360° view data received."));
                }
            }
            else if (typeof data.response === 'string') {
                addMessageToChat(createMessageElement(false, data.response));
            }
            else {
                addMessageToChat(createMessageElement(false, "Unexpected response received."));
                console.warn("Unexpected response:", data);
            }
        } else {
            const errorMessage = data.error || `Server error: ${response.status}`;
            addMessageToChat(createMessageElement(false, `Error: ${errorMessage}`));
            console.error("Chat API error:", response.status, data);
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Chat error:', error);
        addMessageToChat(createMessageElement(false, `Communication error: ${error.message}`));
    } finally {
        if (isChatReady) enableChat();
        chatInput.focus();
    }
}

sendButton.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

document.addEventListener('DOMContentLoaded', initializeAssistant);
</script>
</body>
</html>
